<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kestrel 5400 WBGT/TWL Demo</title>
<style>
  :root { --pad: 16px; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:var(--pad);line-height:1.5}
  main{max-width:980px;margin:auto}
  h1{margin-bottom:0.25rem}
  .card{border:1px solid #e5e5e5;border-radius:12px;padding:var(--pad);margin:var(--pad) 0}
  label{display:inline-block;margin:.25rem 0}
  input,button,select,textarea{padding:6px 10px;border:1px solid #d0d0d0;border-radius:8px}
  button{cursor:pointer}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .row > * { flex: 1 1 auto }
  canvas{max-width:100%;height:auto}
  code{background:#f6f6f6;padding:0 4px;border-radius:4px}
  .muted{color:#666}
  textarea{width:100%;height:160px}
  details{margin:.5rem 0}
</style>
</head>
<body>
<main>
  <h1>Kestrel 5400 WBGT/TWL Demo</h1>
  <p class="muted">Single-file site for GitHub Pages. Load a CSV exported from Kestrel LiNK (or paste CSV), then render WBGT.</p>

  <div class="card">
    <h2>Load Data</h2>
    <div class="row">
      <div>
        <label for="csvFile">Load CSV from your computer</label><br>
        <input type="file" id="csvFile" accept=".csv">
      </div>
      <div>
        <label for="csvUrl">…or fetch CSV by URL (e.g., <code>data/run.csv</code> if you add a folder later)</label><br>
        <input id="csvUrl" placeholder="data/session_sample.csv">
        <button id="fetchBtn">Fetch</button>
      </div>
    </div>

    <details>
      <summary>…or paste CSV (must include <code>timestamp</code> and a WBGT column)</summary>
      <textarea id="csvText"></textarea>
      <div style="margin-top:8px">
        <button id="pasteBtn">Render pasted CSV</button>
      </div>
      <p class="muted" style="margin-top:.5rem">Expected headers include <code>timestamp</code> and a column containing <code>wbgt</code> in its name (e.g., <code>wbgt_outdoor_c</code> or <code>WBGT_F</code>).</p>
    </details>
  </div>

  <div class="card">
    <h2>WBGT Chart</h2>
    <canvas id="wbgtChart" width="960" height="420" aria-label="WBGT chart"></canvas>
    <p class="muted">Tip: Stabilize sensors 8–15 minutes in the target environment; measure ~1 m (≈3 ft) above ground; same sun/wind as subjects; back of unit into wind; tripod/vane recommended.</p>
  </div>

  <div class="card">
    <h2>Protocol (Edit This Section)</h2>
    <ul>
      <li>Configure WBGT: Type (Indoor/Outdoor), Zones/Alerts, and logging interval.</li>
      <li>Min/Avg/Max window; use <code>Capture</code> to tag events (e.g., sun/cloud change).</li>
      <li>Export via Kestrel LiNK; load CSV here or host it in the repo later under <code>data/</code>.</li>
    </ul>
  </div>

  <div class="card">
    <h2>Data Column Hints</h2>
    <p>Common columns that work here:</p>
    <pre><code>timestamp, wbgt_outdoor_c, globe_c, nwb_c, drybulb_c, rh_pct, wind_ms, heat_index_c, twl_wm2, alert_zone</code></pre>
  </div>

  <p class="muted">This page uses Chart.js via CDN. No build step is required.</p>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  if (!lines.length) throw new Error('Empty CSV.');
  const header = lines.shift().split(',').map(h=>h.trim());
  const idxTime = header.findIndex(h => h.toLowerCase() === 'timestamp');
  const idxWBGT = header.findIndex(h => /wbgt/i.test(h));
  if (idxTime === -1 || idxWBGT === -1) {
    throw new Error('CSV must include columns: timestamp and a WBGT column (name contains "wbgt").');
  }
  const labels = [];
  const wbgt = [];
  for (const line of lines) {
    if (!line.trim()) continue;
    const cols = line.split(',').map(c=>c.trim());
    const t = cols[idxTime];
    const v = parseFloat(cols[idxWBGT]);
    labels.push(t);
    wbgt.push(Number.isFinite(v) ? v : null);
  }
  return { labels, wbgt };
}

let chart;
function renderChart(labels, wbgt){
  const ctx = document.getElementById('wbgtChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{ label: 'WBGT', data: wbgt }]
    },
    options: {
      parsing: false,
      interaction: { mode: 'nearest', intersect: false },
      scales: {
        x: { title: { display: true, text: 'Time' } },
        y: { title: { display: true, text: 'WBGT' } }
      }
    }
  });
}

document.getElementById('csvFile').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if (!f) return;
  const text = await f.text();
  const {labels, wbgt} = parseCSV(text);
  renderChart(labels, wbgt);
});

document.getElementById('fetchBtn').addEventListener('click', async ()=>{
  const url = document.getElementById('csvUrl').value.trim();
  if (!url) return alert('Enter a CSV URL (e.g., data/run.csv).');
  try{
    const res = await fetch(url);
    if (!res.ok) throw new Error('Fetch failed: ' + res.status);
    const text = await res.text();
    const {labels, wbgt} = parseCSV(text);
    renderChart(labels, wbgt);
  }catch(err){
    alert(err.message);
  }
});

document.getElementById('pasteBtn').addEventListener('click', ()=>{
  const text = document.getElementById('csvText').value.trim();
  if (!text) return alert('Paste CSV first.');
  try{
    const {labels, wbgt} = parseCSV(text);
    renderChart(labels, wbgt);
  }catch(err){
    alert(err.message);
  }
});
</script>
</body>
</html>
