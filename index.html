<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kestrel 5400 WBGT/TWL Demo</title>
<style>
  :root { --pad: 16px; --border:#e5e5e5; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:var(--pad);line-height:1.5}
  main{max-width:1000px;margin:auto}
  .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin-bottom:12px}
  .tab{padding:8px 12px;border:1px solid var(--border);border-bottom:none;border-top-left-radius:10px;border-top-right-radius:10px;background:#fafafa;cursor:pointer}
  .tab.active{background:#fff;font-weight:600}
  .panel{border:1px solid var(--border);border-radius:10px;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input,button{padding:6px 10px;border:1px solid #d0d0d0;border-radius:8px}
  canvas{max-width:100%;height:auto}
  code{background:#f6f6f6;padding:0 4px;border-radius:4px}
  .muted{color:#666}
</style>
</head>
<body>
<main>
  <nav class="tabs">
    <button class="tab active" data-tab="main">Main</button>
    <button class="tab" data-tab="steps">How-To Steps</button>
    <button class="tab" data-tab="glossary">Glossary</button>
  </nav>

  <section id="main" class="panel">
    <h1>Kestrel 5400 WBGT/TWL Demo</h1>
    <p class="muted">Load a CSV exported from Kestrel LiNK (or paste CSV), then render WBGT.</p>

    <div class="row" style="margin:8px 0 16px">
      <div>
        <label for="csvFile">Load CSV from your computer</label><br>
        <input type="file" id="csvFile" accept=".csv">
      </div>
      <div>
        <label for="csvUrl">…or fetch CSV by URL (e.g., <code>data/run.csv</code>)</label><br>
        <input id="csvUrl" placeholder="data/session_sample.csv" style="min-width:280px">
        <button id="fetchBtn">Fetch</button>
      </div>
    </div>

    <details>
      <summary>…or paste CSV (must include <code>timestamp</code> and a WBGT column)</summary>
      <textarea id="csvText" style="width:100%;height:160px"></textarea>
      <div style="margin-top:8px">
        <button id="pasteBtn">Render pasted CSV</button>
      </div>
    </details>

    <div style="margin-top:16px">
      <canvas id="wbgtChart" width="960" height="420" aria-label="WBGT chart"></canvas>
      <p class="muted">Field protocol: allow 8–15 minutes to equilibrate; measure ~1 m (≈3 ft) above ground; match sun/wind to subjects; back of unit into wind; tripod/vane recommended.</p>
    </div>
  </section>

  <section id="steps" class="panel" hidden></section>
  <section id="glossary" class="panel" hidden></section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* --- Tabs --- */
const tabs = document.querySelectorAll('.tab');
const panels = { main: document.getElementById('main'),
                 steps: document.getElementById('steps'),
                 glossary: document.getElementById('glossary') };

async function openTab(name){
  tabs.forEach(t => t.classList.toggle('active', t.dataset.tab===name));
  Object.entries(panels).forEach(([k,el]) => el.hidden = (k!==name));
  if (name==='steps' && !panels.steps.dataset.loaded){
  const html = await fetch('html/steps.html').then(r=>r.text());
  panels.steps.innerHTML = html;
  panels.steps.dataset.loaded = '1';
}
if (name==='glossary' && !panels.glossary.dataset.loaded){
  const html = await fetch('html/glossary.html').then(r=>r.text());
  panels.glossary.innerHTML = html;
  panels.glossary.dataset.loaded = '1';
}
}
tabs.forEach(btn => btn.addEventListener('click', () => openTab(btn.dataset.tab)));

/* --- CSV -> Chart --- */
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  if (!lines.length) throw new Error('Empty CSV.');
  const header = lines.shift().split(',').map(h=>h.trim());
  const idxTime = header.findIndex(h => h.toLowerCase() === 'timestamp');
  const idxWBGT = header.findIndex(h => /wbgt/i.test(h));
  if (idxTime === -1 || idxWBGT === -1) {
    throw new Error('CSV must include columns: timestamp and a WBGT column (name contains "wbgt").');
  }
  const labels = [], wbgt = [];
  for (const line of lines) {
    if (!line.trim()) continue;
    const cols = line.split(',').map(c=>c.trim());
    labels.push(cols[idxTime]);
    const v = parseFloat(cols[idxWBGT]);
    wbgt.push(Number.isFinite(v) ? v : null);
  }
  return { labels, wbgt };
}

let chart;
function renderChart(labels, wbgt){
  const ctx = document.getElementById('wbgtChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'WBGT', data: wbgt }] },
    options: {
      parsing: false,
      interaction: { mode: 'nearest', intersect: false },
      scales: {
        x: { title: { display: true, text: 'Time' } },
        y: { title: { display: true, text: 'WBGT' } }
      }
    }
  });
}

/* File/URL/Paste handlers */
document.getElementById('csvFile').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if (!f) return;
  const text = await f.text(); const {labels, wbgt} = parseCSV(text); renderChart(labels, wbgt);
});
document.getElementById('fetchBtn').addEventListener('click', async ()=>{
  const url = document.getElementById('csvUrl').value.trim();
  if (!url) return alert('Enter a CSV URL (e.g., data/run.csv).');
  const res = await fetch(url); if (!res.ok) return alert('Fetch failed: '+res.status);
  const text = await res.text(); const {labels, wbgt} = parseCSV(text); renderChart(labels, wbgt);
});
document.getElementById('pasteBtn').addEventListener('click', ()=>{
  const text = document.getElementById('csvText').value.trim();
  if (!text) return alert('Paste CSV first.');
  const {labels, wbgt} = parseCSV(text); renderChart(labels, wbgt);
});
</script>
</body>
</html>
